@using System.Globalization
@using FoodTruck.ViewModels
@using System.Configuration;
@using FoodTruck.Models
@model PanierViewModel
@{
    ViewBag.Title = "FoodTruckLyon - Panier";
    string dossierImagesArticles = ConfigurationManager.AppSettings["PathImagesArticles"];
    Utilisateur utilisateur = ViewBag.Utilisateur;
}
<h2>Votre panier :</h2>
<dl class="dl-horizontal"></dl>

<aside id="panierValide">
    <div class="listePanier">
        @{int i = 0;}
        @foreach (var articleDetailViewModel in Model.ArticlesDetailsViewModel)
        {
            <div>
                <a href="/Article/@articleDetailViewModel.NomPourUrl">
                    <img src="@dossierImagesArticles/@articleDetailViewModel.Article.Image" alt="@articleDetailViewModel.Article.Nom" />
                </a>
                @articleDetailViewModel.Quantite<span>x </span><a href="/Article/@articleDetailViewModel.NomPourUrl">@articleDetailViewModel.Article.Nom</a>
            </div>
            using (Html.BeginForm("Retirer", "Panier", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post, new { @class = "plus_moins" }))
            {
                <input name="id" value="@i" hidden>
                <button class="ajoutSupprPanierTexte" type="submit">retirer</button>
            }
            using (Html.BeginForm("Ajouter", "Panier", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post, new { @class = "plus_moins" }))
            {
                <input name="nom" value="@articleDetailViewModel.Article.Nom" hidden>
                <button class="ajoutSupprPanierTexte" type="submit">ajouter</button>
            }
            <p class="sousTotal">@articleDetailViewModel.PrixTotal.ToString("C2", new CultureInfo("fr-FR"))</p>
            <hr />
            i++;
        }
    </div>
    <hr />
</aside>
@if (Model.ArticlesDetailsViewModel.Count == 0)
{
    <h4>Votre panier est vide. Venez <a href="/Article">découvrir notre carte.</a></h4>
}
else
{
    <h3 class="total">Total : @Model.PrixTotal.ToString("C2", new CultureInfo("fr-FR"))</h3>
    <h2>Votre retrait :</h2>
    using (Html.BeginForm("Index", "Commande", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post))
    {
        <div class="choixHoraire">
            <select class="ccformfield" name="dateRetrait" size="1" required>
                <option selected disabled>créneau horaire de retrait</option>
                @{
                    string groupeRepas1 = "";
                    string groupeRepas2 = "";
                    int jourRepas1 = 0;
                    const int heureMinPourDiner = 16;
                }
                @foreach (DateTime date in Model.DatesRetraitPossibles)
                {
                    if (groupeRepas1 == "" && date.Hour < heureMinPourDiner)
                    {
                        groupeRepas1 = "Déjeuner";
                        jourRepas1 = date.DayOfYear;
                        <optgroup label="@groupeRepas1 du @date.ToString("dddd dd MMMM")"></optgroup>
                    }
                    else if (groupeRepas1 == "" && date.Hour >= heureMinPourDiner)
                    {
                        groupeRepas1 = "Diner";
                        jourRepas1 = date.DayOfYear;
                        <optgroup label="@groupeRepas1 du @date.ToString("dddd dd MMMM")"></optgroup>
                    }
                    else if (groupeRepas2 == "" && date.Hour < heureMinPourDiner && (groupeRepas1 == "Diner" || date.DayOfYear != jourRepas1) )
                    {
                        groupeRepas2 = "Déjeuner";
                        <optgroup label="@groupeRepas2 du @date.ToString("dddd dd MMMM")"></optgroup>

                    }
                    else if (groupeRepas2 == "" && date.Hour >= heureMinPourDiner && (groupeRepas1 == "Déjeuner" || date.DayOfYear != jourRepas1) )
                    {
                        groupeRepas2 = "Diner";
                        <optgroup label="@groupeRepas2 du @date.ToString("dddd dd MMMM")"></optgroup>

                    }
                    <option value="@date">@date.ToString("HH:mm").Replace(":", "h")</option>
                }
            </select>
        </div>
        <h3 class="total">
            <button class="validerPanier" type="submit">Commander</button>
        </h3>
    }
    if (utilisateur.Id == 0)
    {
        <div class="messageInfo">Vous n'êtes pas connecté à votre compte. Vous pouvez commander mais la commande ne sera pas dans votre historique et vous ne recevrez pas de mail de confirmation.</div>
    }

}
